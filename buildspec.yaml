version: 0.2
env:
  parameter-store:
    dburl: "/database/jdbcurl"
    dbuser: "/database/dbuser"
    dbpassword: "/database/dbpass"

phases:
  install:
    on-failure: ABORT
    commands:
      - echo "Installing Flyway ..."
      - wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/7.9.2/flyway-commandline-7.9.2.tar.gz | tar xvz && ln -s `pwd`/flyway-7.9.2/flyway /usr/local/bin 
  build:
    on-failure: ABORT
    commands:
      - echo "Migrating DB on `date` in `pwd`"
      - echo "DB URL $dburl" 
      - echo "DB User $dbuser"
      # - flyway migrate -url=$dburl -user=$dbuser -password=$dbpassword
      - flyway migrate -url="jdbc:mysql://rds-sample-cluster.cluster-chq2lxfvsjxh.ap-northeast-2.rds.amazonaws.com:3306/testflyway" \
                   -user="master" -password="password"
  post_build:
    on-failure: ABORT
    commands:
      - echo "SAM packaging completed on `date`"
artifacts:
  files:
    ./